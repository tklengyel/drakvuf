FROM ubuntu:18.04
LABEL maintainer.name="CERT.PL " \
      maintainer.email="michal.leszczynski@cert.pl"

ENV DEBIAN_FRONTEND=noninteractive
ENV USER root

# build depends
RUN mkdir -p /log && \
    apt-get update && \
    echo Running apt-get install, this may take a few minutes... && \
    apt-get --quiet --yes install \
        wget git bcc bin86 gawk bridge-utils iproute2 libcurl4-openssl-dev bzip2 pciutils-dev build-essential make gcc clang libc6-dev libc6-dev-i386 linux-libc-dev zlib1g-dev libncurses5-dev patch libvncserver-dev libssl-dev iasl libbz2-dev e2fslibs-dev git-core uuid-dev ocaml libx11-dev bison flex ocaml-findlib xz-utils gettext libyajl-dev libpixman-1-dev libaio-dev libfdt-dev cabextract libglib2.0-dev autoconf automake libtool libjson-c-dev libfuse-dev liblzma-dev autoconf-archive kpartx python-dev cmake libsdl-dev >/log/apt.log 2>&1 && \
        apt-get autoremove -y && \
        apt-get clean && \
        rm -rf /var/lib/apt/lists* /tmp/* /var/tmp/*

COPY xen /build-xen
COPY package/patch-xen.sh /build-xen
RUN cd /build-xen && \
    chmod +x patch-xen.sh && \
    ./patch-xen.sh && \
    echo Building Xen, this may take a few minutes... && \
    ./configure --prefix=/usr --enable-githttp --disable-pvshim >/log/xen-configure.log 2>&1 && \
    echo "Running Xen's make dist..." && \
    make -j$(nproc) dist >/log/xen-make-dist.log 2>&1 && \
    echo "Running Xen's make install-xen..." && \
    make -j$(nproc) install-xen >/log/xen-install.log 2>&1 && \
    echo "Running Xen's make install-tools..." && \
    make -j$(nproc) install-tools >/log/xen-install-tools.log 2>&1

COPY . /build
RUN cd /build/libvmi && \
    cmake -DENABLE_KVM=OFF -DENABLE_FILE=OFF -DENABLE_BAREFLANK=OFF -DCMAKE_INSTALL_PREFIX=/usr . && \
    make -j$(nproc) && \
    make install && \
    ldconfig
RUN cd /build && \
    autoreconf -vi && \
    ./configure && \
    make -j$(nproc)

WORKDIR /build
RUN chmod +x package/mkdeb
CMD ./package/mkdeb ubuntu-18.04
